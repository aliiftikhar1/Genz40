{% extends "public/layout/base.html" %}
{% load static %}
{% load humanize %}
{% block header %}
<style>
    body{
        background-color: #fff !important;
    }
    .shadow{
        box-shadow: 0 0 1px #000!important;
    }
    .form-control {
        background-color: #fff !important;
        color: #000 !important;
    }
</style>
{% endblock header %}

{% block content %}
<section class="bg-half-100 d-table w-100">
    <div class="container bg-white">
        <div class="layout-specing bg-white">
            <div class="row bg-white">
                <div class="col-md-12 col-lg-12 mt-4">
                    <div class="card rounded shadow p-4 border-4 bg-white">
                        <div class="row">
                            <div class="col-6">
                                <h3 class="text-light">{{ items.title }}</h3>
                                <span class="badge bg-info">Est. Delivery - Mar 31, 2025</span>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'car_details' items.slug %}" class="btn btn-sm btn-outline-secondary text-light text-uppercase float-end mt-3">
                                    <i class="mdi mdi-arrow-left-thin"></i>Back</a>
                            </div>
                        </div>
                        
                        <div class="alert alert-info alert-dismissible fade show text-light mt-3 mb-3" role="alert"
                            style="background-color: rgb(59 130 246 / .2)!important; border-color: rgb(59 130 246 / .5) !important;">
                            <i class="uil uil-info-circle fs-5 align-middle me-1 text-light"></i><strong
                                class="text-uppercase">Reserve now, Configure later</strong><br>
                            This reservation will save your position in line. When you car is available
                            for production, we will invite you to configure and choose from dozens of options to make it
                            complete personalized and unique.
                            <button type="button" class="btn-close btn btn-icon btn-sm text-black float-end"
                                style="width: 20px; height: 20px; background-color: rgb(59 130 246 / .9) !important;"
                                data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <!-- <form class="needs-validation bg-white text-light" novalidate> -->
                        <form class="bg-white text-light" id="checkout-form" method="POST">
                                {% csrf_token %}
                                <input type="text" value="{{ random_password }}" name="password1" hidden>
                                <input type="text" value="{{ random_password }}" name="password2" hidden>
                                <input type="text" value="{{ country_code }}" name="country" hidden>
                                <input type="text" value="customer" name="role" hidden>
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <label for="firstName" class="form-label">First Name<span class="text-danger"> *</span></label>
                                    <input type="text" class="form-control" name="first_name"
                                    id="first_name" value="{{user_data.first_name}}" required />
                                </div>

                                <div class="col-sm-6">
                                    <label for="lastName" class="form-label">Last Name<span class="text-danger"> *</span></label>
                                    <input type="text" class="form-control" name="last_name"
                                    id="last_name" value="{{user_data.last_name}}" required />
                                </div>

                                <div class="col-sm-6">
                                    <label for="email" class="form-label">Email<span class="text-danger"> *</span></label>
                                    <input type="email" class="form-control" name="email" id="email"
                                    value="{{user_data.email}}" required />
                                </div>

                                <div class="col-sm-6 position-relative">
                                    <label for="phone_number" class="form-label">Phone Number<span class="text-danger"> *</span></label>
                                    <div class="input-group has-validation">
                                        <span class="input-group-text bg-white text-muted border" style="border-radius: 4px 0px 0px 4px;"><img class="fea icon-sm icons" src="{{ country_flag_url }}"
                                            alt="Country Flag" style="width: 28px; height: 28px;" /></span>
                                            <input type="tel" class="form-control" name="phone_number"
                                            value="{{user_data.phone_number}}" id="phone_number" maxlength="14" required />
                                    </div>
                                </div>

                                <div class="col-sm-3">
                                    <label for="zip_code" class="form-label">Delivery Zip Code<span class="text-danger"> *</span></label>
                                    <input type="text" class="form-control" name="zip_code" id="zip_code"
                                    value="{{ user_data.zip_code|default_if_none:"" }}" maxlength="5" required />
                                </div>

                                <div class="col-md-12 text-light">
                                    <small class="text-gray text-sm" style="font-size: 11px;">
                                        By entering my contact information above, I authorize Alvi Automobiles to
                                        contact me about this request and Alvi Automobiles UpdatesÂ including other Alvi
                                        Automobiles
                                        products, services and events. I can opt out in the Alvi Automobiles app or by
                                        unsubscribing. This is not a purchase requirement.</span>
    
                                    </small>
                                </div>
    
                                <div class="col-md-12 text-light mt-3 mb-1 text-sm" style="font-size: 11px;">
                                    <h4 class="mb-0">Due Today
                                        <span class="mb-0 float-end mt-2">$ {{ amount_due }}</span>
                                    </h4>
                                    <!-- <h4 class="mb-0 float-end">$100</h4> -->
                                    <small>Fully Refundable</small>
                                </div>

                            </div>

                            <input type="hidden" value="{{ amount_due }}" name="amount" />
                             <input type="hidden" value="{{ items.title }}" name="package" />
                             <div class="d-grid mt-3 mb-1">
                                <button type="submit"
                                    class="mb-1 btn btn-secondary text-light text-uppercase">
                                    <!-- <i class="mdi mdi-arrow-right-thin"></i> -->
                                    Reserve Now
                                    <span class="spinner-border spinner-border-sm" id="pro1" role="status"
                                        aria-hidden="true" style="display: none;"></span>
                                </button>
                            </div>
                            <div class="col-md-12 text-light mb-5">
                                <small class="text-light text-sm mb-5" style="font-size: 11px;">
                                    By placing this order, I understand that this is just the reservation fee and not a
                                    car purchase price.
                                    The Final price of the car will depend on options and features I choose. Reservation
                                    today will save your spot and lock your price for either Package "Roller or Turnkey
                                    Minus"
                                </small>
                            </div>
                        </form>
                    </div>
                </div><!--end col-->
            </div><!--end row-->
        </div>
    </div><!--end container-->
</section>
{% endblock content %}

{% block script %}
<script>
    window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
            location.reload();  // Reload page if accessed via back button
        }
    });
</script>
<script>
    document.getElementById("phone_number").addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, ""); // Remove non-numeric characters
    
        if (value.length > 10) value = value.substring(0, 10); // Limit to 10 digits
    
        let formattedValue = value;
    
        if (value.length > 6) {
            formattedValue = `(${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6)}`;
        } else if (value.length > 3) {
            formattedValue = `(${value.substring(0, 3)}) ${value.substring(3)}`;
        } else if (value.length > 0) {
            formattedValue = `(${value}`;
        }
    
        e.target.value = formattedValue;
    });
</script>
<script>
    $("#checkout-form").submit(function (e) {
    e.preventDefault();
    var data = new FormData(this);
    $('#pro').show();
        $.ajax({
            type: 'POST',
            url: "{% url 'create_account_before_checkout' %}",
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            crossDomain: true,
            success: function (response) {
                if (response.is_success) {
                    console.log(response['session_data']);
                    call_checkout(response['session_data']);
                    // toastr.success(response['message']);
                   
                } else {
                    toastr.error(response['message']);
                }
                $('#pro').hide();
            },
            error: function (response) {
                if (!response.is_success) {
                    toastr.error(response['message']);
                }
                // alert the error if any error occurred
                $('#pro').hide();
            }
        })
    })

function call_checkout(session_data){
    console.log('-----=--=-', session_data);
    $.ajax({
            type: 'POST',
            url: "{% url 'create_checkout_session' %}",
            data: JSON.stringify(session_data), 
            headers: {
                'X-CSRFToken': getCookie('csrftoken'), // Fix CSRF Issue
                "Content-Type": "application/json"
            },
            success: function (response) {
                console.log('-----=--=response-', response);
                if (response.is_success) {
                    // toastr.success(response['message']);
                    window.location.href = response.checkout_url;
                } else {
                    toastr.error(response['message']);
                }
            },
            error: function (response) {
                if (!response.is_success) {
                    toastr.error(response['message']);
                }
            }
        });
}
</script>
<script>
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock script %}