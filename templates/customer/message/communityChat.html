{% extends "public/layout/base.html" %}
{% load static %}
{% block header %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
.community-chat-container {
    width: 100%;
    height: calc(100vh - 160px);
    background: #000;
    color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.18);
    display: flex;
    flex-direction: column;
    font-family: 'Inter', sans-serif;
    overflow: hidden;
}
.community-chat-header {
    background-color: #1a1a1a;
    color: #fff;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.community-chat-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 500;
    flex-grow: 1;
}
#community-connection-status {
    font-size: 0.75rem;
    background: rgba(255,255,255,0.1);
    color: #fff;
    padding: 4px 10px;
    border-radius: 12px;
    transition: all 0.3s ease;
}
#community-room-list {
    flex: 1;
    overflow-y: auto;
    background: #222;
}
.community-room-item {
    padding: 12px 16px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #fff;
}
.community-room-item:hover {
    background-color: #333;
}
.community-room-item.unread {
    background-color: #333333;
}
.community-room-title {
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #fff;
}
.community-room-unread-count {
    background: #fff;
    color: #000;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.community-badge {
    background-color: #4a6fdc;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 8px;
}
#community-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    background: #111;
    display: none;
    flex-direction: column;
    gap: 12px;
}
.community-message {
    padding: 10px 14px;
    border-radius: 12px;
    max-width: 80%;
    word-break: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    position: relative;
    color: #fff;
}
.community-message.sent {
    background-color: #333;
    margin-left: auto;
    border-top-right-radius: 4px;
}
.community-message.received {
    background-color: #222;
    margin-right: auto;
    border-top-left-radius: 4px;
}
.community-message-sender {
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 4px;
    color: #fff;
}
.community-message-time {
    font-size: 0.7rem;
    color: #aaa;
    text-align: right;
    margin-top: 4px;
}
#community-message-input {
    padding: 12px 16px;
    border-top: 1px solid #333;
    background: #000;
    display: none;
}
#community-chat-input-container {
    display: flex;
    align-items: center;
    gap: 8px;
}
#community-chat-input {
    flex-grow: 1;
    padding: 10px 16px;
    border: 1px solid #444;
    border-radius: 20px;
    font-size: 0.9rem;
    outline: none;
    background: #111;
    color: #fff;
}
#community-send-button {
    padding: 8px 20px;
    background-color: #000;
    color: #fff;
    border: 1px solid #fff;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s ease;
}
#community-send-button:hover {
    background-color: #222;
    transform: translateY(-1px);
}
#community-typing-indicator {
    font-size: 0.75rem;
    color: #aaa;
    height: auto;
    margin-top: 8px;
}
#community-image-upload-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 8px;
}
#community-image-upload-btn:hover {
    color: #ccc;
}
.upload-progress {
    width: 100%;
    height: 4px;
    background: #333;
    margin-top: 8px;
    border-radius: 2px;
    overflow: hidden;
    display: none;
}
.upload-progress-bar {
    height: 100%;
    background: #4a6fdc;
    width: 0%;
    transition: width 0.3s;
}
.message-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-top: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}
.message-image:hover {
    transform: scale(1.02);
}
</style>
{% endblock %}

{% block content %}
<section class="section bg-black">
    <div class="container">
        <div class="layout-specing">
            <div class="row">
                <div class="col-lg-3">
                    {% include "customer/sidebar.html" %}
                </div>
                <div class="col-lg-9">
                    <div class="community-chat-container" data-user-id="{{ user_data.user_id }}">
                        <div class="community-chat-header">
                            <h3 id="community-chat-title">Community Chats</h3>
                            <span id="community-connection-status">Offline</span>
                        </div>
                        <div id="community-room-list"></div>
                        <div id="community-messages"></div>
                        <div id="community-message-input">
                            <div id="community-chat-input-container">
                                <button id="community-image-upload-btn" aria-label="Upload image">
                                    <i class="fas fa-image" aria-hidden="true"></i>
                                </button>
                                <input id="community-chat-input" type="text" class="form-control" placeholder="Type your message..." autocomplete="off" aria-label="Message input">
                                <button id="community-send-button" class="btn" aria-label="Send message">Send</button>
                            </div>
                            <div class="upload-progress">
                                <div class="upload-progress-bar"></div>
                            </div>
                            <div id="community-typing-indicator"></div>
                        </div>
                        <input type="file" id="community-file-input" accept="image/*" style="display: none;" aria-hidden="true">
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block script %}
<script>
// This script is a simplified version of the chat_widget's logic, adapted for community chat only
// It supports: room list, unread, badge, sender/time, image upload, typing, websocket, etc.
document.addEventListener('DOMContentLoaded', function() {
    const userId = document.querySelector('.community-chat-container').dataset.userId;
    let currentRoomId = null;
    let socket = null;
    let typingTimer = null;
    let typingDelay = 1000;
    let renderedMessageIds = new Set();

    const elements = {
        roomList: document.getElementById('community-room-list'),
        messages: document.getElementById('community-messages'),
        messageInput: document.getElementById('community-message-input'),
        input: document.getElementById('community-chat-input'),
        sendBtn: document.getElementById('community-send-button'),
        imageUploadBtn: document.getElementById('community-image-upload-btn'),
        fileInput: document.getElementById('community-file-input'),
        typingIndicator: document.getElementById('community-typing-indicator'),
        connectionStatus: document.getElementById('community-connection-status'),
        chatTitle: document.getElementById('community-chat-title'),
    };

    function updateConnectionStatus(status, isError = false) {
        elements.connectionStatus.textContent = status;
        elements.connectionStatus.className = isError ? 'bg-danger bg-opacity-25 text-white px-2 py-1 rounded-pill' : 'px-2 py-1 rounded-pill';
    }

    function showCommunityBadge() {
        return '<span class="community-badge">Community</span>';
    }

    async function loadRooms() {
        const res = await fetch('/api/chat/community/rooms/', { credentials: 'include' });
        const rooms = await res.json();
        console.log("Community Rooms are : ", rooms);
        elements.roomList.innerHTML = '';
        if (!rooms.length) {
            elements.roomList.innerHTML = '<div class="text-white text-center">No community rooms available.</div>';
            return;
        }
        rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = 'community-room-item' + (room.unread_count > 0 ? ' unread' : '');
            div.innerHTML = `<div class="community-room-title">${room.subject}${showCommunityBadge()}
                ${room.unread_count > 0 ? `<span class='community-room-unread-count'>${room.unread_count}</span>` : ''}</div>
                <div style="font-size:0.8rem; color:#ccc; margin-top:4px;">${room.last_message ? (room.last_message.sender_name || 'System') + ': ' + (room.last_message.message_type === 'image' ? '[Image]' : (room.last_message.content?.substring(0, 40) || '')) : 'No messages yet'}</div>
                <div style="font-size:0.75rem; color:#aaa; text-align:right;">${room.last_message ? room.last_message.timestamp : ''}</div>`;
            div.onclick = () => openRoom(room.id, room.community.name);
            elements.roomList.appendChild(div);
        });
    }

    async function openRoom(roomId, name) {
        currentRoomId = roomId;
        elements.roomList.style.display = 'none';
        elements.messages.style.display = 'flex';
        elements.messageInput.style.display = 'block';
        elements.chatTitle.textContent = name;
        renderedMessageIds.clear();
        await loadMessages(roomId);
        markRead(roomId);
        connectWebSocket();
    }

    async function loadMessages(roomId) {
        if (!roomId) return;
        const res = await fetch(`/api/chat/rooms/${roomId}/messages/`, { credentials: 'include' });
        const messages = await res.json();
        elements.messages.innerHTML = '';
        renderedMessageIds.clear();
        if (!messages.length) {
            const placeholder = document.createElement('div');
            placeholder.className = 'text-center p-4 text-white';
            placeholder.textContent = 'No messages yet. Start the conversation!';
            elements.messages.appendChild(placeholder);
        } else {
            messages.forEach(addMessageToChat);
            scrollToBottom();
        }
    }

    function addMessageToChat(message) {
        if (renderedMessageIds.has(message.id)) return;
        renderedMessageIds.add(message.id);
        const isCurrentUser = String(message.sender_id) === userId;
        const messageElement = document.createElement('div');
        messageElement.className = `community-message ${isCurrentUser ? 'sent' : 'received'}`;
        messageElement.dataset.messageId = message.id;
        const senderDiv = document.createElement('div');
        senderDiv.className = 'community-message-sender';
        senderDiv.textContent = isCurrentUser ? 'You' : (message.sender_name || 'User');
        const contentDiv = document.createElement('div');
        contentDiv.textContent = message.content || '';
        const timeDiv = document.createElement('div');
        timeDiv.className = 'community-message-time';
        timeDiv.textContent = message.timestamp;
        messageElement.appendChild(senderDiv);
        messageElement.appendChild(contentDiv);
        if (message.image_url) {
            const img = document.createElement('img');
            img.src = message.image_url;
            img.className = 'message-image';
            img.alt = 'Uploaded image';
            img.addEventListener('click', () => window.open(img.src, '_blank'));
            messageElement.appendChild(img);
        }
        messageElement.appendChild(timeDiv);
        elements.messages.appendChild(messageElement);
    }

    async function sendMessage() {
        const message = elements.input.value.trim();
        if (!message || !currentRoomId) return;
        elements.input.value = '';
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'chat', message, room_id: currentRoomId }));
        } else {
            await fetch(`/api/chat/rooms/${currentRoomId}/send/`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                body: JSON.stringify({ content: message })
            });
        }
        setTimeout(() => loadMessages(currentRoomId), 300);
    }

    function getCSRFToken() {
        // First try to get token from meta tag
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            return metaTag.getAttribute('content');
        }
        
        // If not found in meta tag, try to get from cookie
        const name = 'csrftoken';
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith(name + '='))
            ?.split('=')[1];
            
        if (cookieValue) {
            return decodeURIComponent(cookieValue);
        }
        
        console.error('CSRF token not found');
        return '';
    }

    async function handleImageUpload(file) {
        if (!file || !file.type.match('image.*')) {
            showToast('Please select a valid image');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            showToast('Image must be under 5MB');
            return;
        }

        const formData = new FormData();
        formData.append('image', file);
        formData.append('room_id', currentRoomId);

        const progressBar = document.querySelector('.upload-progress-bar');
        const uploadProgress = document.querySelector('.upload-progress');

        if (!progressBar || !uploadProgress) {
            console.warn('Progress bar elements not found');
            return;
        }

        uploadProgress.style.display = 'block';
        progressBar.style.width = '0%';

        try {
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                throw new Error('CSRF token not found');
            }

            console.log("Going to upload image with CSRF token:", csrfToken);
            const response = await fetch('/api/chat/upload-image/', {
                method: 'POST',
                body: formData,
                credentials: 'include',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
            });

            if (!response.ok) {
                throw new Error('Upload failed');
            }

            const data = await response.json();
            
            // Send message with image URL through WebSocket
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'image',
                    room_id: currentRoomId,
                    image_url: data.image_url,
                    content: 'Image shared'
                }));
            }
            loadMessages(currentRoomId);
            progressBar.style.width = '100%';
            setTimeout(() => uploadProgress.style.display = 'none', 500);
        } catch (error) {
            console.error('Image upload failed:', error);
            showToast('Failed to upload image');
            uploadProgress.style.display = 'none';
        }
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function handleTyping() {
        if (typingTimer) clearTimeout(typingTimer);
        if (elements.input.value.trim().length > 0 && socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'typing', is_typing: true, room_id: currentRoomId }));
            typingTimer = setTimeout(() => { elements.typingIndicator.textContent = ''; }, typingDelay);
        } else {
            elements.typingIndicator.textContent = '';
        }
    }

    function scrollToBottom() {
        elements.messages.scrollTop = elements.messages.scrollHeight;
    }

    function markRead(roomId) {
        fetch(`/api/chat/rooms/${roomId}/read/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            credentials: 'include'
        });
    }

    function connectWebSocket() {
        if (socket) socket.close();
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = `${protocol}${window.location.host}/ws/chat/global/`;
        socket = new WebSocket(wsUrl);
        socket.onopen = () => {
            updateConnectionStatus('Online');
            if (currentRoomId) {
                socket.send(JSON.stringify({ type: 'join', room_id: currentRoomId }));
            }
        };
        socket.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'pong') return;
                if (data.type === 'typing') {
                    if (data.sender_id !== userId && currentRoomId === data.room_id) {
                        elements.typingIndicator.textContent = 'Someone is typing...';
                        setTimeout(() => elements.typingIndicator.textContent = '', 3000);
                    }
                    return;
                }
                if (data.type === 'chat' || data.type === 'image') {
                    if (data.room_id === currentRoomId) {
                        loadMessages(data.room_id);
                        scrollToBottom();
                        markRead(data.room_id);
                    } else {
                        loadRooms();
                    }
                }
            } catch (error) {}
        };
        socket.onclose = () => updateConnectionStatus('Offline', true);
        socket.onerror = () => updateConnectionStatus('Connection error', true);
    }

    elements.sendBtn.onclick = sendMessage;
    elements.input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    elements.input.addEventListener('input', handleTyping);
    elements.imageUploadBtn.onclick = () => elements.fileInput.click();
    elements.fileInput.onchange = (e) => { const file = e.target.files[0]; if (file) { handleImageUpload(file); e.target.value = ''; } };

    loadRooms();
});
</script>
{% endblock %}
