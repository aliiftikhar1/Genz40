<style>
    #chat-widget {
        /* background-color: #000000; */
        position: fixed;
        bottom: 15px;
        right: 15px;
        z-index: 1000;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #chat-button {
        position: absolute;
        bottom: 0;
        right: 0;
        z-index: -100;
        background-color: #000000;
        color: #ffffff;
        width: 60px;
        height: 60px;
        border: 1px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }

    #unread-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ffffff;
        color: #000000;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    #chat-container {
        width: 50rem;
        height: 40rem;
        background: #000000;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .chat-header {
        background-color: #1a1a1a;
        color: #ffffff;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #chat-header {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
        flex-grow: 1;
        color: #ffffff;
    }

    #connection-status {
        font-size: 0.75rem;
        background: rgba(255,255,255,0.1);
        color: #ffffff;
        padding: 4px 10px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    #chatroom-list {
        flex: 1;
        overflow-y: auto;
        background: #ffffff30;
    }

    .chatroom-item {
        padding: 12px 16px;
        border-bottom: 1px solid #333333;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #ffffff;
    }

    .chatroom-item:hover {
        background-color: #222222;
    }

    .chatroom-item.unread {
        background-color: #333333;
    }

    .chatroom-title {
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ffffff;
    }

    .chatroom-unread-count {
        background: #ffffff;
        color: #000000;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background: #111111;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message {
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 80%;
        word-break: break-word;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        position: relative;
        color: #ffffff;
    }

    .message.sent {
        background-color: #333333;
        margin-left: auto;
        border-top-right-radius: 4px;
    }

    .message.received {
        background-color: #222222;
        margin-right: auto;
        border-top-left-radius: 4px;
    }

    .message-sender {
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 4px;
        color: #ffffff;
    }

    .message-time {
        font-size: 0.7rem;
        color: #aaaaaa;
        text-align: right;
        margin-top: 4px;
    }

    .message-status {
        font-size: 0.65rem;
        text-align: right;
        margin-top: 2px;
        color: #aaaaaa;
    }

    #message-input {
        padding: 12px 16px;
        border-top: 1px solid #333333;
        background: #000000;
    }

    #chat-input {
        padding: 10px 16px;
        border: 1px solid #444444;
        border-radius: 20px;
        font-size: 0.9rem;
        outline: none;
        transition: all 0.3s ease;
        background: #111111;
        color: #ffffff;
    }

    #chat-input:focus {
        border-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
    }

    #send-button {
        padding: 8px 20px;
        background-color: #000000;
        color: #ffffff;
        border: 1px solid white;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    #send-button:hover {
        background-color: #222222;
        transform: translateY(-1px);
    }

    #typing-indicator {
        font-size: 0.75rem;
        color: #aaaaaa;
        height: auto;
        margin-top: 8px;
    }

    .btn-icon {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-icon:hover {
        color: #cccccc;
    }

    #new-chat-button {
        position: absolute;
        bottom: 1rem;
        right: 0;
        background-color: #333333;
        color: #ffffff;
        padding: 8px 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 12px 16px;
        transition: all 0.3s ease;
    }

    #new-chat-button:hover {
        background-color: #444444;
        transform: translateY(-1px);
    }

    #new-chat-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .modal-content {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        width: 300px;
        color: #ffffff;
    }

    .modal-content input {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        border: 1px solid #444444;
        border-radius: 4px;
        background: #111111;
        color: #ffffff;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
    }

    .modal-buttons button {
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-buttons .cancel {
        background: #333333;
        color: #ffffff;
    }

    .modal-buttons .create {
        background: #000000;
        color: #ffffff;
    }

    @media (max-width: 576px) {
        #chat-widget {
            background-color: #000000;
            position: fixed;
            bottom: 5rem;
            right: 1rem;
            z-index: 1000;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #chat-container {
            width: 100%;
            height: 70vh;
            border-radius: 0;
            bottom: 0;
            right: 0;
        }
    }
</style>

<div id="chat-widget">
    <div id="chat-button" class="shadow">
        <i class="fas fa-comment"></i>
        <span id="unread-count" style="display: none;">0</span>
    </div>
    
    <div id="chat-container" style="display: none;">
        <div class="chat-header">
            <button id="back-button" class="btn-icon" style="display: none;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 id="chat-header">Chat Support</h3>
            <div class="d-flex align-items-center gap-2">
                <span id="connection-status">Ready</span>
                <button id="close-chat" class="btn-icon">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div id="chatroom-list">
            <button id="new-chat-button">
                <i class="fas fa-plus"></i>
            </button>
            <div id="chatrooms-container"></div>
        </div>

        <div id="chat-messages" style="display: none;"></div>

        <div id="message-input" >
            <div class="d-flex gap-2">
                <input id="chat-input" type="text" class="form-control" placeholder="Type your message..." autocomplete="off">
                <button id="send-button" class="btn">Send</button>
            </div>
            <div id="typing-indicator"></div>
        </div>
    </div>

    <div id="new-chat-modal">
        <div class="modal-content">
            <h4>New Chat Room</h4>
            <input id="chat-subject" type="text" placeholder="Enter subject">
            <div class="modal-buttons">
                <button class="cancel">Cancel</button>
                <button class="create">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatWidget = document.getElementById('chat-widget');
    const chatButton = document.getElementById('chat-button');
    const chatContainer = document.getElementById('chat-container');
    const closeChat = document.getElementById('close-chat');
    const chatMessages = document.getElementById('chat-messages');
    const chatroomList = document.getElementById('chatroom-list');
    const chatroomsContainer = document.getElementById('chatrooms-container');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const connectionStatus = document.getElementById('connection-status');
    const unreadCount = document.getElementById('unread-count');
    const typingIndicator = document.getElementById('typing-indicator');
    const backButton = document.getElementById('back-button');
    const messageInput = document.getElementById('message-input');
    const chatHeader = document.getElementById('chat-header');
    const newChatButton = document.getElementById('new-chat-button');
    const newChatModal = document.getElementById('new-chat-modal');
    const chatSubjectInput = document.getElementById('chat-subject');
    const modalCancelButton = newChatModal.querySelector('.cancel');
    const modalCreateButton = newChatModal.querySelector('.create');

    let chatSocket = null;
    let currentRoomId = null;
    let currentRoomName = null;
    let pingInterval = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let unreadMessages = 0;
    let isChatOpen = false;
    let typingTimer = null;
    const typingDelay = 1000;
    let currentView = 'chatrooms';

    function initChat() {
        toggleChat(isChatOpen);
        fetchUnreadCounts();
        setInterval(fetchUnreadCounts, 30000);
    }

    function toggleChat(open) {
        isChatOpen = open;
        chatContainer.style.display = open ? 'flex' : 'none';
        if (open) {
            showChatroomList();
        } else {
            if (chatSocket) {
                chatSocket.close();
                clearInterval(pingInterval);
            }
            reconnectAttempts = 0;
            closeModal();
        }
    }

    async function showChatroomList() {
        currentView = 'chatrooms';
        chatroomList.style.display = 'block';
        chatMessages.style.display = 'none';
        messageInput.style.display = 'none';
        backButton.style.display = 'none';
        chatHeader.textContent = 'Chat Support';

        try {
            const response = await fetch('/api/chat/rooms/list/', {
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Failed to load chatrooms');

            const chatrooms = await response.json();
            console.log("Chat rooms are : ",chatrooms)
            renderChatrooms(chatrooms);
        } catch (error) {
            console.error('Error loading chatrooms:', error);
            showErrorMessage('Failed to load conversations');
        }
    }

    async function readMessages(roomId) {
        try {
            await fetch(`/api/chat/rooms/${roomId}/read/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                credentials: 'include'
            });
            fetchUnreadCounts();
        } catch (e) {
            console.warn('Failed to mark messages as read:', e);
        }
    }

    function renderChatrooms(chatrooms) {
    chatroomsContainer.innerHTML = '';

    if (chatrooms.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'p-3 text-center text-white';
        emptyMsg.textContent = 'No conversations yet';
        chatroomsContainer.appendChild(emptyMsg);
        return;
    }

    chatrooms.forEach(chatroom => {
        const chatroomElement = document.createElement('div');
        chatroomElement.className = `chatroom-item ${chatroom.unread_count > 0 ? 'unread' : ''}`;
        let name = '';
        let avatarContent = '';
        const userRole = `{{user_data.role}}`;

        // Determine name and avatar based on user role
        if (userRole === 'customer') {
            name = chatroom.subject;
            avatarContent = 'A'; // Customer gets 'A' as avatar
        } else {
            name = chatroom.customer_name + " - " + chatroom.subject;
            // Use first letter of customer_name, or fallback to 'S' if name is empty
            avatarContent = chatroom.customer_name ? chatroom.customer_name.charAt(0).toUpperCase() : 'S';
        }

        chatroomElement.innerHTML = `
            <div class="d-flex flex-row " style="gap:20px">
                <div style="width:30px; height:30px; border-radius:50%; background-color:white; color:black; justify-content:center; display:grid; align-items:center; text-align:center;">
                    ${avatarContent}
                </div>
                <div class="d-flex flex-column flex-grow-1">
                    <div class="chatroom-title">
                        ${name || 'Support Team'}
                        ${chatroom.unread_count > 0 ? 
                            `<span class="chatroom-unread-count">${chatroom.unread_count}</span>` : ''}
                    </div>
                    <div class="text-white" style="font-size: 0.8rem; margin-top: 4px;">
                        ${chatroom.last_message ? 
                            `<span class="${chatroom.unread_count > 0 ? 'fw-semibold' : ''}">
                            ${chatroom.last_message.content.substring(0, 40)}${chatroom.last_message.content.length > 40 ? '...' : ''}
                            </span>` : 'No messages yet'}
                    </div>
                </div>
            </div>
            <div class="text-white text-end" style="font-size: 0.75rem; min-width: 50px;">
                ${chatroom.last_message ? formatTimeShort(chatroom.last_message.timestamp) : ''}
            </div>
        `;

        chatroomElement.addEventListener('click', () => {
            if (userRole === 'customer') {
                openChatroom(chatroom.id, chatroom.subject || 'Support');
            } else {
                openChatroom(chatroom.id, chatroom.customer_name + " - " + chatroom.subject || 'Support');
            }
        });

        chatroomsContainer.appendChild(chatroomElement);
    });
}

    async function openChatroom(roomId, roomName) {
        currentView = 'messages';
        currentRoomId = roomId;
        currentRoomName = roomName;

        chatroomList.style.display = 'none';
        chatMessages.style.display = 'flex';
        messageInput.style.display = 'block';
        backButton.style.display = 'block';
        chatHeader.textContent = roomName;

        await loadMessages(roomId);
        connectWebSocket(roomId);
        readMessages(roomId);
    }

    async function loadMessages(roomId) {
        if (!roomId) return;

        try {
            const response = await fetch(`/api/chat/rooms/${roomId}/messages/`, {
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Failed to load messages');

            const messages = await response.json();
            console.log("Messages of this room : ",messages)
            chatMessages.innerHTML = '';

            if (messages.length === 0) {
                showNoMessagesPlaceholder();
            } else {
                messages.forEach(addMessageToChat);
                scrollToBottom();
            }
        } catch (error) {
            console.error('Failed to load messages:', error);
            showErrorMessage('Failed to load messages');
        }
    }

    async function createNewChatRoom(subject) {
    try {
        const response = await fetch('/api/chat/rooms/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            credentials: 'include',
            body: JSON.stringify({ subject: subject })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }

        const newChatRoom = await response.json();
        closeModal();
        showChatroomList();
        openChatroom(newChatRoom.id, subject);  // Use subject as the room name
    } catch (error) {
        console.error('Error creating chat room:', error);
        showErrorMessage(error.message);
    }
}

    function connectWebSocket(roomId) {
        if (!roomId) return;

        if (chatSocket) {
            chatSocket.close();
            clearInterval(pingInterval);
        }

        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const host = window.location.host;
        const wsUrl = `${protocol}${host}/ws/chat/${roomId}/`;

        console.log('Connecting to WebSocket:', wsUrl);
        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = () => {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            updateConnectionStatus('Online');

            pingInterval = setInterval(() => {
                if (chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.send(JSON.stringify({ type: 'ping' }));
                }
            }, 25000);
        };

        chatSocket.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);

                if (data.type === 'pong') return;
                if (data.type === 'error') {
                    showErrorMessage(data.error);
                    return;
                }

                if (data.type === 'chat') {
                    loadMessages(roomId);
                    readMessages(roomId);
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error processing message:', error);
            }
        };

        chatSocket.onclose = (e) => {
            console.log('WebSocket closed:', e.code, e.reason);
            clearInterval(pingInterval);

            if (e.code === 1000) {
                updateConnectionStatus('Offline');
                return;
            }

            updateConnectionStatus('Reconnecting...');
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(3000 * reconnectAttempts, 30000);
                console.log(`Reconnecting in ${delay/1000}s...`);
                setTimeout(() => connectWebSocket(roomId), delay);
            } else {
                updateConnectionStatus('Disconnected', true);
                showErrorMessage('Connection lost. Please refresh the page.');
            }
        };

        chatSocket.onerror = (error) => {
            console.error('WebSocket error:', error);
            updateConnectionStatus('Connection error', true);
        };
    }

    function addMessageToChat(message) {
        const guserData = `{{user_data.user_id}}`;
        const isCurrentUser = String(message.sender) === '{{ user_data.user_id }}';

        const placeholder = chatMessages.querySelector('div.text-center');
        if (placeholder) placeholder.remove();

        const messageElement = document.createElement('div');
        messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;

        messageElement.innerHTML = `
            <div class="message-sender">${isCurrentUser ? 'You' : (message.sender_name || 'Support')}</div>
            <div>${message.content}</div>
            <div class="message-time">${message.timestamp}</div>
            ${isCurrentUser ? 
                `<div class="message-status ${message.is_read ? 'text-success' : 'text-white'}">
                    ${message.is_read ? '✓ Read' : '✓ Delivered'}
                </div>` : ''}
        `;

        chatMessages.appendChild(messageElement);
    }

    function showNoMessagesPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'text-center p-4 text-white';
        placeholder.textContent = 'No messages yet. Start the conversation!';
        chatMessages.appendChild(placeholder);
    }

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || !currentRoomId) return;

        try {
            if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
                throw new Error('Connection not ready');
            }

            chatInput.value = '';
            scrollToBottom();

            chatSocket.send(JSON.stringify({
                message: message,
                sender_id: '{{ user_data.user_id }}'
            }));

        } catch (error) {
            console.error('Failed to send message:', error);
            showErrorMessage('Failed to send message. Please try again.');
        }
    }

    async function fetchUnreadCounts() {
        try {
            const response = await fetch('/api/chat/notifications/', {
                credentials: 'include'
            });

            if (response.ok) {
                const notifications = await response.json();
                const totalUnread = notifications.reduce((sum, notif) => sum + notif.count, 0);

                if (totalUnread > 0) {
                    unreadCount.textContent = totalUnread;
                    unreadCount.style.display = 'flex';
                } else {
                    unreadCount.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Failed to fetch unread counts:', error);
        }
    }

    function handleTyping() {
        if (typingTimer) clearTimeout(typingTimer);

        if (chatInput.value.trim().length > 0) {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: 'typing',
                    is_typing: true
                }));
            }

            typingTimer = setTimeout(() => {
                typingIndicator.textContent = '';
            }, typingDelay);
        } else {
            typingIndicator.textContent = '';
        }
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatTimeShort(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();

        if (date.toDateString() === now.toDateString()) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function getCSRFToken() {
        const cookieValue = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
        return cookieValue ? cookieValue.pop() : null;
    }

    function showErrorMessage(message) {
        const errorElement = document.createElement('div');
        errorElement.className = 'text-center p-2 text-danger bg-danger bg-opacity-10 rounded';
        errorElement.textContent = message;
        chatMessages.appendChild(errorElement);
    }

    function updateConnectionStatus(status, isError = false) {
        connectionStatus.textContent = status;
        connectionStatus.className = isError ? 'bg-danger bg-opacity-25 text-danger px-2 py-1 rounded-pill' : 'px-2 py-1 rounded-pill';
    }

    function openModal() {
        newChatModal.style.display = 'flex';
        chatSubjectInput.value = '';
        chatSubjectInput.focus();
    }

    function closeModal() {
        newChatModal.style.display = 'none';
    }

    newChatButton.addEventListener('click', openModal);
    modalCancelButton.addEventListener('click', closeModal);
    modalCreateButton.addEventListener('click', () => {
        const subject = chatSubjectInput.value.trim();
        if (subject) {
            createNewChatRoom(subject);
        } else {
            showErrorMessage('Please enter a subject');
        }
    });

    chatButton.addEventListener('click', () => toggleChat(chatContainer.style.display === 'none'));
    closeChat.addEventListener('click', () => toggleChat(false));
    backButton.addEventListener('click', showChatroomList);

    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    chatInput.addEventListener('input', handleTyping);

    window.addEventListener('beforeunload', () => {
        if (chatSocket) {
            chatSocket.close();
            clearInterval(pingInterval);
        }
    });

    initChat();
});
</script>