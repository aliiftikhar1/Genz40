<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    #chat-widget {
        position: fixed;
        bottom: 15px;
        right: 15px;
        z-index: 1000;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #chat-button {
        position: absolute;
        bottom: 0;
        right: 0;
        z-index: -100;
        background-color: #000000;
        color: #ffffff;
        width: 60px;
        height: 60px;
        border: 1px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }

    #chat-button.flash {
        animation: flash 0.5s ease-in-out 2;
    }

    @keyframes flash {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }

    #unread-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ffffff;
        color: #000000;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    #chat-container {
        width: 50rem;
        height: 40rem;
        background: #000000;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .chat-header {
        background-color: #1a1a1a;
        color: #ffffff;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #chat-header {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
        flex-grow: 1;
        color: #ffffff;
    }

    #connection-status {
        font-size: 0.75rem;
        background: rgba(255,255,255,0.1);
        color: #ffffff;
        padding: 4px 10px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    #chatroom-list {
        flex: 1;
        overflow-y: auto;
        background: #ffffff30;
    }

    .chatroom-item {
        padding: 12px 16px;
        border-bottom: 1px solid #333333;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #ffffff;
    }

    .chatroom-item:hover {
        background-color: #222222;
    }

    .chatroom-item.unread {
        background-color: #333333;
    }

    .chatroom-title {
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ffffff;
    }

    .chatroom-unread-count {
        background: #ffffff;
        color: #000000;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background: #111111;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message {
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 80%;
        word-break: break-word;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        position: relative;
        color: #ffffff;
    }

    .message.sent {
        background-color: #333333;
        margin-left: auto;
        border-top-right-radius: 4px;
    }

    .message.received {
        background-color: #222222;
        margin-right: auto;
        border-top-left-radius: 4px;
    }

    .message-sender {
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 4px;
        color: #ffffff;
    }

    .message-time {
        font-size: 0.7rem;
        color: #aaaaaa;
        text-align: right;
        margin-top: 4px;
    }

    .message-status {
        font-size: 0.65rem;
        text-align: right;
        margin-top: 2px;
        color: #aaaaaa;
    }

    #message-input {
        padding: 12px 16px;
        border-top: 1px solid #333333;
        background: #000000;
    }

    #chat-input {
        padding: 10px 16px;
        border: 1px solid #444444;
        border-radius: 20px;
        font-size: 0.9rem;
        outline: none;
        transition: all 0.3s ease;
        background: #111111;
        color: #ffffff;
    }

    #chat-input:focus {
        border-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
    }

    #send-button {
        padding: 8px 20px;
        background-color: #000000;
        color: #ffffff;
        border: 1px solid white;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    #send-button:hover {
        background-color: #222222;
        transform: translateY(-1px);
    }

    #typing-indicator {
        font-size: 0.75rem;
        color: #aaaaaa;
        height: auto;
        margin-top: 8px;
    }

    .btn-icon {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-icon:hover {
        color: #cccccc;
    }

    #new-chat-button {
        position: absolute;
        bottom: 1rem;
        right: 0;
        background-color: #333333;
        color: #ffffff;
        padding: 8px 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 12px 16px;
        transition: all 0.3s ease;
    }

    #new-chat-button:hover {
        background-color: #444444;
        transform: translateY(-1px);
    }

    #new-chat-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .modal-content {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        width: 300px;
        color: #ffffff;
    }

    .modal-content input {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        border: 1px solid #444444;
        border-radius: 4px;
        background: #111111;
        color: #ffffff;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
    }

    .modal-buttons button {
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-buttons .cancel {
        background: #333333;
        color: #ffffff;
    }

    .modal-buttons .create {
        background: #000000;
        color: #ffffff;
    }

    #toast-notification {
        position: fixed;
        top: 80px;
        right: 15px;
        background-color: #333333;
        color: #ffffff;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
        z-index: 1100;
        max-width: 300px;
        height: min-content;
        font-size: 0.9rem;
        animation: fadeIn 0.3s ease;
    }

    #toast-notification.show {
        display: block !important;
    }

    #chat-tooltip {
        position: absolute;
        bottom: 70px;
        right: 0;
        background-color: #1a1a1a;
        color: #ffffff;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        width: 20rem;
        font-size: 0.85rem;
        z-index: 1200;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        pointer-events: none;
    }

    #chat-tooltip.show {
        opacity: 1;
        transform: translateY(0);
    }

    #chat-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        right: 20px;
        border: 8px solid transparent;
        border-top-color: #1a1a1a;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 767px) {
        #chat-widget {
            background-color: #000000;
            position: fixed;
            bottom: 5rem;
            right: 1rem;
            z-index: 1000;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #chat-container {
            width: 100%;
            height: 70vh;
            border-radius: 0;
            bottom: 0;
            right: 0;
        }
        #toast-notification {
            bottom: 100px;
            right: 1rem;
            max-width: 80%;
        }
        #chat-tooltip {
            right: 10px;
            bottom: 60px;
            max-width: 200px;
        }
    }

    .message-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        margin-top: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .message-image:hover {
        transform: scale(1.02);
    }

    #image-upload-btn {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 8px;
    }

    #image-upload-btn:hover {
        color: #cccccc;
    }

    #image-preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
    }

    #image-preview-content {
        max-width: 90%;
        max-height: 90%;
    }

    #image-preview-content img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
    }

    #close-preview {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 2rem;
        cursor: pointer;
    }

    .community-badge {
        background-color: #4a6fdc;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
    }

    .upload-progress {
        width: 100%;
        height: 4px;
        background: #333333;
        margin-top: 8px;
        border-radius: 2px;
        overflow: hidden;
        display: none;
    }

    .upload-progress-bar {
        height: 100%;
        background: #4a6fdc;
        width: 0%;
        transition: width 0.3s;
    }

    #message-input {
        position: relative;
    }

    #chat-input-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #chat-input {
        flex-grow: 1;
    }
</style>

<div id="chat-widget" data-user-role="{{ user_data.role|escapejs }}" data-user-id="{{ user_data.user_id }}" data-is-authenticated="{{ user_data.is_authenticated|yesno:'true,false' }}">
    {% if user_data.is_authenticated %}
    <div id="chat-button" class="shadow">
        <i class="fas fa-comment" aria-hidden="true"></i>
        <span id="unread-count" style="display: none;">0</span>
    </div>
    {% if user_data.role == 'customer' %}
    <div id="chat-tooltip">Chat with our admin team in real-time for instant support!</div>
    {% endif %}
    {% endif %}

    <div id="chat-container" style="display: none;">
        <div class="chat-header">
            <button id="back-button" class="btn-icon" style="display: none;" aria-label="Back to chatroom list">
                <i class="fas fa-arrow-left" aria-hidden="true"></i>
            </button>
            <h3 id="chat-header">Chat Support</h3>
            <div class="d-flex align-items-center gap-2">
                <span id="connection-status">Ready</span>
                <button id="close-chat" class="btn-icon" aria-label="Close chat">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
        </div>

        <div id="chatroom-list">
            <button id="new-chat-button" aria-label="Create new chat">
                <i class="fas fa-plus" aria-hidden="true"></i>
            </button>
            <div id="chatrooms-container"></div>
        </div>

        <div id="chat-messages" style="display: none;"></div>

        <div id="message-input">
            <div id="chat-input-container">
                <button id="image-upload-btn" aria-label="Upload image">
                    <i class="fas fa-image" aria-hidden="true"></i>
                </button>
                <input id="chat-input" type="text" class="form-control" placeholder="Type your message..." autocomplete="off" aria-label="Message input">
                <button id="send-button" class="btn" aria-label="Send message">Send</button>
            </div>
            <div class="upload-progress">
                <div class="upload-progress-bar"></div>
            </div>
            <div id="typing-indicator"></div>
        </div>
    </div>

    <div id="new-chat-modal">
        <div class="modal-content">
            <h4>New Chat Room</h4>
            <input id="chat-subject" type="text" placeholder="Enter subject" aria-label="Chat room subject">
            <div class="modal-buttons">
                <button class="cancel" aria-label="Cancel">Cancel</button>
                <button class="create" aria-label="Create chat room">Create</button>
            </div>
        </div>
    </div>

    <div id="image-preview-modal">
        <span id="close-preview" aria-label="Close image preview">×</span>
        <div id="image-preview-content">
            <img src="" alt="Preview">
        </div>
    </div>

    <div id="toast-notification"></div>
</div>

<input type="file" id="file-input" accept="image/*" style="display: none;" aria-hidden="true">

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatWidget = document.getElementById('chat-widget');
    if (!chatWidget) {
        console.error('Chat widget not found');
        return;
    }

    const elements = {
        chatButton: document.getElementById('chat-button'),
        chatContainer: document.getElementById('chat-container'),
        closeChat: document.getElementById('close-chat'),
        chatMessages: document.getElementById('chat-messages'),
        chatroomList: document.getElementById('chatroom-list'),
        chatroomsContainer: document.getElementById('chatrooms-container'),
        chatInput: document.getElementById('chat-input'),
        sendButton: document.getElementById('send-button'),
        connectionStatus: document.getElementById('connection-status'),
        unreadCount: document.getElementById('unread-count'),
        typingIndicator: document.getElementById('typing-indicator'),
        backButton: document.getElementById('back-button'),
        chatHeader: document.getElementById('chat-header'),
        newChatButton: document.getElementById('new-chat-button'),
        newChatModal: document.getElementById('new-chat-modal'),
        chatSubjectInput: document.getElementById('chat-subject'),
        modalCancelButton: document.querySelector('#new-chat-modal .cancel'),
        modalCreateButton: document.querySelector('#new-chat-modal .create'),
        toastNotification: document.getElementById('toast-notification'),
        chatTooltip: document.getElementById('chat-tooltip'),
        imageUploadBtn: document.getElementById('image-upload-btn'),
        fileInput: document.getElementById('file-input'),
        imagePreviewModal: document.getElementById('image-preview-modal'),
        closePreview: document.getElementById('close-preview'),
        messageInput: document.getElementById('message-input'),
    };

    // Log missing elements
    Object.entries(elements).forEach(([key, value]) => {
        if (!value) {
            console.warn(`Element ${key} not found`);
        }
    });

    const state = {
        globalSocket: null,
        currentRoomId: null,
        currentRoomName: null,
        pingInterval: null,
        reconnectAttempts: 0,
        maxReconnectAttempts: 5,
        isChatOpen: false,
        typingTimer: null,
        typingDelay: 1000,
        currentView: 'chatrooms',
        userRole: chatWidget.dataset.userRole || '',
        currentUserId: chatWidget.dataset.userId || '',
        isAuthenticated: chatWidget.dataset.isAuthenticated === 'true'
    };
    console.log("Data is: ", chatWidget.dataset);

    if (!state.isAuthenticated) {
        console.log('User not authenticated');
        return;
    }

    // Initialize tooltip
    if (elements.chatTooltip) {
        elements.chatTooltip.classList.add('show');
        setTimeout(() => elements.chatTooltip.classList.remove('show'), 5000);
    }

    async function handleImageUpload(file) {
        if (!file || !file.type.match('image.*')) {
            showToast('Please select a valid image');
            return;
        }
    
        if (file.size > 5 * 1024 * 1024) {
            showToast('Image size should be less than 5MB');
            return;
        }
    
        const formData = new FormData();
        formData.append('image', file);
        formData.append('room_id', state.currentRoomId);
    
        const progressBar = document.querySelector('.upload-progress-bar');
        const uploadProgress = document.querySelector('.upload-progress');
    
        if (!progressBar || !uploadProgress) {
            console.warn('Progress bar elements not found');
            return;
        }
    
        uploadProgress.style.display = 'block';
        progressBar.style.width = '0%';
    
        try {
            const response = await fetch('/api/chat/upload-image/', {
                method: 'POST',
                body: formData,
                credentials: 'include',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                },
            });
    
            if (!response.ok) {
                throw new Error('Upload failed');
            }
    
            const data = await response.json();
            
            // Send message with image URL through WebSocket
            if (state.globalSocket?.readyState === WebSocket.OPEN) {
                state.globalSocket.send(JSON.stringify({
                    type: 'image',
                    room_id: state.currentRoomId,
                    image_url: data.image_url,
                    content: 'Image shared'
                }));
            }
    
            progressBar.style.width = '100%';
            await loadMessages(state.currentRoomId);
            setTimeout(() => uploadProgress.style.display = 'none', 500);
        } catch (error) {
            console.error('Image upload failed:', error);
            showToast('Failed to upload image');
            uploadProgress.style.display = 'none';
        }
    }

    function renderImageMessage(message) {
        const isCurrentUser = String(message.sender) === state.currentUserId;
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;

        const senderDiv = document.createElement('div');
        senderDiv.className = 'message-sender';
        senderDiv.textContent = isCurrentUser ? 'You' : (message.sender_name || 'Support');

        const contentDiv = document.createElement('div');
        contentDiv.textContent = message.content || '';

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = message.timestamp;

        messageElement.appendChild(senderDiv);
        messageElement.appendChild(contentDiv);

        if (message.image_url) {
            const img = document.createElement('img');
            img.src = message.image_url;
            img.className = 'message-image';
            img.alt = 'Uploaded image';
            img.addEventListener('click', () => {
                if (elements.imagePreviewModal) {
                    elements.imagePreviewModal.querySelector('img').src = img.src;
                    elements.imagePreviewModal.style.display = 'flex';
                }
            });
            messageElement.appendChild(img);
        }

        messageElement.appendChild(timeDiv);

        if (isCurrentUser) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `message-status ${message.is_read ? 'text-success' : 'text-white'}`;
            statusDiv.textContent = message.is_read ? '✓ Read' : '✓ Delivered';
            messageElement.appendChild(statusDiv);
        }

        return messageElement;
    }

    function showCommunityBadge(chatroom) {
        if (chatroom.chat_type === 'community') {
            const badge = document.createElement('span');
            badge.className = 'community-badge';
            badge.textContent = 'Community';
            return badge.outerHTML;
        }
        return '';
    }

    async function initChat() {
        try {
            toggleChat(state.isChatOpen);
            fetchUnreadCounts();
            setInterval(fetchUnreadCounts, 30000);
            connectGlobalWebSocket();

            const [privateResponse, communityResponse] = await Promise.all([
                fetch('/api/chat/rooms/list/', { credentials: 'include' }),
                fetch('/api/chat/community/rooms/', { credentials: 'include' })
            ]);

            if (!privateResponse.ok || !communityResponse.ok) {
                throw new Error('Failed to load chatrooms');
            }

            const [privateRooms, communityRooms] = await Promise.all([
                privateResponse.json(),
                communityResponse.json()
            ]);
            console.log("Private chatrooms are: ", privateRooms, "Community Chat rooms are: ", communityRooms);

            const allRooms = [...privateRooms, ...communityRooms].sort((a, b) => {
                const aTime = new Date(a.last_message?.timestamp || a.created_at);
                const bTime = new Date(b.last_message?.timestamp || b.created_at);
                return bTime - aTime;
            });
            console.log("All rooms are: ", allRooms);

            renderChatrooms(allRooms);
        } catch (error) {
            console.error('Error initializing chat:', error);
            showToast('Failed to load conversations');
        }
    }

    function toggleChat(open) {
        state.isChatOpen = open;
        elements.chatContainer.style.display = open ? 'flex' : 'none';
        if (open) {
            showChatroomList();
        } else {
            closeModal();
        }
    }

    async function showChatroomList() {
        state.currentView = 'chatrooms';
        elements.chatroomList.style.display = 'block';
        elements.chatMessages.style.display = 'none';
        elements.messageInput.style.display = 'none';
        elements.backButton.style.display = 'none';
        elements.chatHeader.textContent = 'Chat Support';

        try {
            const [privateResponse, communityResponse] = await Promise.all([
                fetch('/api/chat/rooms/list/', { credentials: 'include' }),
                fetch('/api/chat/community/rooms/', { credentials: 'include' })
            ]);

            if (!privateResponse.ok || !communityResponse.ok) {
                throw new Error('Failed to load chatrooms');
            }

            const [privateRooms, communityRooms] = await Promise.all([
                privateResponse.json(),
                communityResponse.json()
            ]);
            console.log("Private chatrooms are: ", privateRooms, "Community Chat rooms are: ", communityRooms);

            const allRooms = [...privateRooms, ...communityRooms].sort((a, b) => {
                const aTime = new Date(a.last_message?.timestamp || a.created_at);
                const bTime = new Date(b.last_message?.timestamp || b.created_at);
                return bTime - aTime;
            });
            renderChatrooms(allRooms);
        } catch (error) {
            console.error('Error loading chatrooms:', error);
            showToast('Failed to load conversations');
        }
    }

    async function readMessages(roomId) {
        try {
            const csrfToken = getCSRFToken();
            const response = await fetch(`/api/chat/rooms/${roomId}/read/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                credentials: 'include'
            });
            if (!response.ok) throw new Error('Failed to mark messages as read');
            fetchUnreadCounts();
        } catch (error) {
            console.warn('Failed to mark messages as read:', error);
        }
    }

    function renderChatrooms(chatrooms) {
        elements.chatroomsContainer.innerHTML = '';
        console.log("Chatrooms are: ", chatrooms);

        if (!chatrooms || !chatrooms.length) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'p-3 text-center text-white';
            emptyMsg.textContent = 'No conversations yet';
            elements.chatroomsContainer.appendChild(emptyMsg);
            return;
        }

        chatrooms.forEach(chatroom => {
            const chatroomElement = document.createElement('div');
            chatroomElement.className = `chatroom-item ${chatroom.unread_count > 0 ? 'unread' : ''}`;
            let name = '';
            let avatarContent = '';

            if (chatroom.chat_type === 'community') {
                name = chatroom.community?.name || 'Community Chat';
                avatarContent = 'C';
            } else if (state.userRole === 'customer') {
                name = chatroom.subject;
                avatarContent = 'A';
            } else {
                name = `${chatroom.customer_name} - ${chatroom.subject}`;
                avatarContent = chatroom.customer_name ? chatroom.customer_name.charAt(0).toUpperCase() : 'S';
            }

            const avatarDiv = document.createElement('div');
            avatarDiv.style.cssText = 'width:30px; height:30px; border-radius:50%; background-color:white; color:black; justify-content:center; display:grid; align-items:center; text-align:center;';
            avatarDiv.textContent = avatarContent;

            const titleDiv = document.createElement('div');
            titleDiv.className = 'chatroom-title';
            titleDiv.textContent = name || 'Support Team';

            const badge = showCommunityBadge(chatroom);
            if (badge) titleDiv.insertAdjacentHTML('beforeend', badge);

            if (chatroom.unread_count > 0) {
                const unreadSpan = document.createElement('span');
                unreadSpan.className = 'chatroom-unread-count';
                unreadSpan.textContent = chatroom.unread_count;
                titleDiv.appendChild(unreadSpan);
            }

            const lastMessageDiv = document.createElement('div');
            lastMessageDiv.className = 'text-white';
            lastMessageDiv.style.cssText = 'font-size: 0.8rem; margin-top: 4px;';
            if (chatroom.last_message) {
                const lastMessageSpan = document.createElement('span');
                lastMessageSpan.className = chatroom.unread_count > 0 ? 'fw-semibold' : '';
                lastMessageSpan.textContent = `${chatroom.last_message.sender_name || 'System'}: ${
                    chatroom.last_message.message_type === 'image' ? '[Image]' : 
                    chatroom.last_message.content.substring(0, 40) + (chatroom.last_message.content.length > 40 ? '...' : '')
                }`;
                lastMessageDiv.appendChild(lastMessageSpan);
            } else {
                lastMessageDiv.textContent = 'No messages yet';
            }

            const timeDiv = document.createElement('div');
            timeDiv.className = 'text-white text-end';
            timeDiv.style.cssText = 'font-size: 0.75rem; min-width: 50px;';
            timeDiv.textContent = chatroom.last_message ? chatroom.last_message.timestamp : '';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'd-flex flex-column flex-grow-1';
            contentDiv.appendChild(titleDiv);
            contentDiv.appendChild(lastMessageDiv);

            const rowDiv = document.createElement('div');
            rowDiv.className = 'd-flex flex-row';
            rowDiv.style.gap = '20px';
            rowDiv.appendChild(avatarDiv);
            rowDiv.appendChild(contentDiv);

            chatroomElement.appendChild(rowDiv);
            chatroomElement.appendChild(timeDiv);

            chatroomElement.addEventListener('click', () => {
                const roomName = chatroom.chat_type === 'community' ? 
                    (chatroom.community?.name || 'Community Chat') :
                    (state.userRole === 'customer' ? 
                        chatroom.subject : 
                        `${chatroom.customer_name} - ${chatroom.subject}`) || 'Support';
                openChatroom(chatroom.id, roomName);
            });

            elements.chatroomsContainer.appendChild(chatroomElement);
        });
    }

    async function openChatroom(roomId, roomName) {
        state.currentView = 'messages';
        state.currentRoomId = roomId;
        state.currentRoomName = roomName;

        elements.chatroomList.style.display = 'none';
        elements.chatMessages.style.display = 'flex';
        elements.messageInput.style.display = 'block';
        elements.backButton.style.display = 'block';
        elements.chatHeader.textContent = roomName;

        await loadMessages(roomId);
        readMessages(roomId);
    }

    async function loadMessages(roomId) {
        if (!roomId) return;

        try {
            const response = await fetch(`/api/chat/rooms/${roomId}/messages/`, { credentials: 'include' });
            if (!response.ok) throw new Error('Failed to load messages');
            const messages = await response.json();
            elements.chatMessages.innerHTML = '';

            if (!messages.length) {
                showNoMessagesPlaceholder();
            } else {
                messages.forEach(addMessageToChat);
                scrollToBottom();
            }
        } catch (error) {
            console.error('Failed to load messages:', error);
            showToast('Failed to load messages');
        }
    }

    async function createNewChatRoom(subject) {
        try {
            const csrfToken = getCSRFToken();
            const response = await fetch('/api/chat/rooms/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                credentials: 'include',
                body: JSON.stringify({ subject })
            });

            if (!response.ok) throw new Error('Failed to create chat room');
            const newChatRoom = await response.json();
            closeModal();
            showChatroomList();
            openChatroom(newChatRoom.id, subject);
        } catch (error) {
            console.error('Error creating chat room:', error);
            showToast('Failed to create chat room');
        }
    }

    function playNotification() {
        try {
            const sound = new Audio('/static/sounds/notification.mp3');
            sound.play().catch(e => console.log('Notification sound error:', e));
        } catch (e) {
            console.log('Audio error:', e);
        }
    }

    function connectGlobalWebSocket() {
        if (state.globalSocket) {
            state.globalSocket.close();
            clearInterval(state.pingInterval);
        }

        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = `${protocol}${window.location.host}/ws/chat/global/`;
        state.globalSocket = new WebSocket(wsUrl);

        state.globalSocket.onopen = () => {
            console.log('Global WebSocket connected');
            state.reconnectAttempts = 0;
            updateConnectionStatus('Online');
            state.pingInterval = setInterval(() => {
                if (state.globalSocket.readyState === WebSocket.OPEN) {
                    state.globalSocket.send(JSON.stringify({ type: 'ping' }));
                }
            }, 25000);
        };

        state.globalSocket.onmessage = async (e) => {
            try {
                const data = JSON.parse(e.data);
                console.log("On message returned data is: ", data);
                if (data.type === 'pong') return;
                if (data.type === 'error') {
                    showToast(data.error);
                    return;
                }

                if (data.type === 'typing') {
                    if (data.sender_id !== state.currentUserId && state.currentRoomId === data.room_id) {
                        elements.typingIndicator.textContent = 'Someone is typing...';
                        setTimeout(() => elements.typingIndicator.textContent = '', 3000);
                    }
                    return;
                }

                if (data.type === 'chat') {
                    const isCurrentUser = data.sender_id === state.currentUserId;
                    const inCurrentRoom = state.currentRoomId === data.room_id;
                    const roomName = data.room_name || 'Support';
                    const senderName = data.sender_name || 'Unknown';
                    const messageText = data.message || '';

                    if (!isCurrentUser) {
                        const notificationText = `${senderName}: ${messageText.substring(0, 50)}${messageText.length > 50 ? '...' : ''}`;
                        if (!state.isChatOpen || !inCurrentRoom) {
                            showToast(notificationText);
                            playNotification();
                        }
                        fetchUnreadCounts();
                    }

                    if (state.isChatOpen && inCurrentRoom) {
                        const message = {
                            sender: data.sender_id,
                            sender_name: data.sender_name || 'Support',
                            content: data.message,
                            timestamp: data.timestamp || new Date().toLocaleTimeString(),
                            is_read: isCurrentUser
                        };
                        addMessageToChat(message);
                        if (!isCurrentUser) readMessages(state.currentRoomId);
                        scrollToBottom();
                    } else if (!inCurrentRoom && !isCurrentUser) {
                        flashChatButton();
                    }
                }
            } catch (error) {
                console.error('WebSocket message error:', error);
                showToast('Error processing message');
            }
        };

        state.globalSocket.onclose = (e) => {
            console.log('WebSocket closed:', e.code, e.reason);
            clearInterval(state.pingInterval);
            if (e.code === 1000) {
                updateConnectionStatus('Offline');
                return;
            }

            if (e.code === 4001) {
                showToast('Authentication required. Please log in.');
                return;
            }

            updateConnectionStatus('Reconnecting...');
            if (state.reconnectAttempts < state.maxReconnectAttempts) {
                state.reconnectAttempts++;
                const delay = Math.min(3000 * Math.pow(2, state.reconnectAttempts), 30000);
                setTimeout(connectGlobalWebSocket, delay);
            } else {
                updateConnectionStatus('Disconnected', true);
                showToast('Connection lost. Please refresh.');
            }
        };

        state.globalSocket.onerror = (error) => {
            console.error('WebSocket error:', error);
            updateConnectionStatus('Connection error', true);
            showToast('WebSocket connection error');
        };
    }

    function addMessageToChat(message) {
        if (message.message_type === 'image') {
            elements.chatMessages.appendChild(renderImageMessage(message));
        } else {
            const isCurrentUser = String(message.sender) === state.currentUserId;
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;

            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = isCurrentUser ? 'You' : (message.sender_name || 'Support');

            const contentDiv = document.createElement('div');
            contentDiv.textContent = message.content;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = message.timestamp;

            messageElement.appendChild(senderDiv);
            messageElement.appendChild(contentDiv);
            messageElement.appendChild(timeDiv);

            if (isCurrentUser) {
                const statusDiv = document.createElement('div');
                statusDiv.className = `message-status ${message.is_read ? 'text-success' : 'text-white'}`;
                statusDiv.textContent = message.is_read ? '✓ Read' : '✓ Delivered';
                messageElement.appendChild(statusDiv);
            }

            elements.chatMessages.appendChild(messageElement);
        }
    }

    function showNoMessagesPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'text-center p-4 text-white';
        placeholder.textContent = 'No messages yet. Start the conversation!';
        elements.chatMessages.appendChild(placeholder);
    }

    async function sendMessage() {
        const message = elements.chatInput.value.trim();
        if (!message || !state.currentRoomId) return;

        try {
            if (!state.globalSocket || state.globalSocket.readyState !== WebSocket.OPEN) {
                throw new Error('WebSocket not connected');
            }

            elements.chatInput.value = '';
            state.globalSocket.send(JSON.stringify({
                type: 'chat',
                message,
                room_id: state.currentRoomId
            }));
            await loadMessages(state.currentRoomId);
            scrollToBottom();
        } catch (error) {
            console.error('Failed to send message:', error);
            showToast('Failed to send message');
        }
    }

    async function fetchUnreadCounts() {
        try {
            const response = await fetch('/api/chat/notifications/', { credentials: 'include' });
            if (!response.ok) throw new Error('Failed to fetch notifications');
            const notifications = await response.json();
            const totalUnread = notifications.reduce((sum, notif) => sum + (notif.count || 0), 0);

            elements.unreadCount.textContent = totalUnread;
            elements.unreadCount.style.display = totalUnread > 0 ? 'flex' : 'none';
        } catch (error) {
            console.error('Failed to fetch unread counts:', error);
        }
    }

    function handleTyping() {
        if (state.typingTimer) clearTimeout(state.typingTimer);

        if (elements.chatInput.value.trim().length > 0) {
            if (state.globalSocket?.readyState === WebSocket.OPEN) {
                state.globalSocket.send(JSON.stringify({
                    type: 'typing',
                    is_typing: true,
                    room_id: state.currentRoomId
                }));
            }

            state.typingTimer = setTimeout(() => {
                elements.typingIndicator.textContent = '';
            }, state.typingDelay);
        } else {
            elements.typingIndicator.textContent = '';
        }
    }

    function scrollToBottom() {
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function getCSRFToken() {
        // Try meta tag first
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) return metaTag.getAttribute('content');

        // Fallback to cookie
        const cookieValue = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
        return cookieValue ? cookieValue.pop() : null;
    }

    function showToast(message) {
        console.log('Showing toast:', message);
        if (!elements.toastNotification) {
            console.error('Toast notification element not found');
            return;
        }
        elements.toastNotification.textContent = message;
        elements.toastNotification.classList.add('show');
        setTimeout(() => {
            elements.toastNotification.classList.remove('show');
        }, 3000);
    }

    function updateConnectionStatus(status, isError = false) {
        elements.connectionStatus.textContent = status;
        elements.connectionStatus.className = isError ? 
            'bg-danger bg-opacity-25 text-white px-2 py-1 rounded-pill' : 
            'px-2 py-1 rounded-pill';
    }

    function openModal() {
        elements.newChatModal.style.display = 'flex';
        elements.chatSubjectInput.value = '';
        elements.chatSubjectInput.focus();
    }

    function closeModal() {
        elements.newChatModal.style.display = 'none';
    }

    function flashChatButton() {
        elements.chatButton.classList.add('flash');
        setTimeout(() => elements.chatButton.classList.remove('flash'), 1000);
    }

    function attachEventListeners() {
        if (elements.newChatButton) {
            elements.newChatButton.addEventListener('click', openModal);
        }
        if (elements.modalCancelButton) {
            elements.modalCancelButton.addEventListener('click', closeModal);
        }
        if (elements.modalCreateButton) {
            elements.modalCreateButton.addEventListener('click', () => {
                const subject = elements.chatSubjectInput.value.trim();
                if (subject) createNewChatRoom(subject);
                else showToast('Please enter a subject');
            });
        }

        if (elements.chatButton) {
            elements.chatButton.addEventListener('click', () => toggleChat(!state.isChatOpen));
        }
        if (elements.closeChat) {
            elements.closeChat.addEventListener('click', () => toggleChat(false));
        }
        if (elements.backButton) {
            elements.backButton.addEventListener('click', showChatroomList);
        }

        if (elements.sendButton) {
            elements.sendButton.addEventListener('click', sendMessage);
        }
        if (elements.chatInput) {
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            elements.chatInput.addEventListener('input', handleTyping);
        }

        if (elements.imageUploadBtn) {
            elements.imageUploadBtn.addEventListener('click', () => {
                elements.fileInput.click();
            });
        }
        if (elements.fileInput) {
            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                    e.target.value = ''; // Reset input
                }
            });
        }

        if (elements.closePreview) {
            elements.closePreview.addEventListener('click', () => {
                elements.imagePreviewModal.style.display = 'none';
            });
        }
        if (elements.imagePreviewModal) {
            elements.imagePreviewModal.addEventListener('click', (e) => {
                if (e.target === elements.imagePreviewModal) {
                    elements.imagePreviewModal.style.display = 'none';
                }
            });
        }
    }

    // Initialize chat on page load
    attachEventListeners();
    initChat();
});
</script>