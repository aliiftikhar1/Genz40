{% extends 'admin/layout/base.html' %}
{% load static %}
{% load custom_filters %}
{% load frontend_custom_filters %}

{% block header %}
<link rel="stylesheet" href="{% static 'admin/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'admin/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'admin/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css' %}">
<style>
    .action-btn {
        margin: 2px;
        padding: 5px 8px;
        min-width: 32px;
        font-size: 0.85rem;
    }

    .modal-dialog {
        max-width: 700px; /* Reduced modal size */
        margin: 1.5rem auto;
    }

    .modal-body {
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .status-select, .filter-select {
        width: 100%;
        height: 34px;
        padding: 5px 10px;
        font-size: 0.9rem;
        border-radius: 4px;
        border: 1px solid #ced4da;
    }

    .form-control {
        font-size: 0.9rem;
        padding: 0.4rem 0.75rem;
        height: calc(1.5em + 0.75rem + 2px);
    }

    .badge-build {
        background-color: #6c757d;
        color: white;
        font-size: 0.8rem;
    }

    .badge-build-status {
        background-color: #17a2b8;
        color: white;
        font-size: 0.8rem;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .form-group {
        margin-bottom: 0.75rem;
    }

    label {
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
    }

    .modal-footer {
        padding: 0.75rem;
    }

    @media (max-width: 768px) {
        .action-btn {
            width: 100%;
            margin: 4px 0;
            text-align: center;
        }

        .modal-dialog {
            max-width: 95%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .filter-select {
            margin-bottom: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Reservations</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
                        <li class="breadcrumb-item active">Reservations</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-8 col-12">
                                    <div class="row">
                                        <div class="col-md-4 col-sm-6 col-12">
                                            <label>Status</label>
                                            <select class="form-control filter-select" id="statusFilter">
                                                <option value="">All Statuses</option>
                                                {% for value, label in booked_packages.first.STATUS_CHOICES %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4 col-sm-6 col-12">
                                            <label>Build Type</label>
                                            <select class="form-control filter-select" id="buildTypeFilter">
                                                <option value="">All Build Types</option>
                                                {% for value, label in booked_packages.first.BUILD_TYPE_CHOICES %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4 col-sm-6 col-12">
                                            <label>Build Status</label>
                                            <select class="form-control filter-select" id="buildStatusFilter">
                                                <option value="">All Build Statuses</option>
                                                {% for value, label in booked_packages.first.BUILD_STATUS_CHOICES %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 col-12">
                                    <label>Search</label>
                                    <div class="input-group input-group-sm">
                                        <input type="text" id="myInputTextField" class="form-control" placeholder="Search...">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-default"><i class="fas fa-search"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table id="package_tbl" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Reservation #</th>
                                            <th>User</th>
                                            <th>Car Model</th>
                                            <th>Title</th>
                                            <th>Price</th>
                                            <th>Status</th>
                                            <th>Build Type</th>
                                            <th>Build Status</th>
                                            {% comment %} <th>Payment Amount</th> {% endcomment %}
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for package in booked_packages %}
                                        <tr>
                                            <td>{{ package.reservation_number }}</td>
                                            <td>{{ package.user.first_name }} {{ package.user.last_name }}</td>
                                            <td>{{ package.car_model.title }}</td>
                                            <td>{{ package.title }}</td>
                                            <td>{{ package.price }}</td>
                                            <td>
                                                <span class="badge {% if package.status == 'confirmed' or package.status == 'in_progress' or package.status == 'delivered' %}badge-success{% elif package.status == 'pending' %}badge-warning{% elif package.status == 'cancelled' %}badge-danger{% endif %}">
                                                    {{ package.status|title_case }}
                                                </span>
                                            </td>
                                            <td><span class="badge badge-build">{{ package.build_type|title_case }}</span></td>
                                            <td><span class="badge badge-build-status">{{ package.build_status|title_case }}</span></td>
                                            {% comment %} <td>{{ package.build_payment_amount }}</td> {% endcomment %}
                                            <td>{{ package.created_at|date:"Y-m-d H:i" }}</td>
                                            <td>{{ package.updated_at|date:"Y-m-d H:i" }}</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-secondary action-btn view-btn"
                                                    data-id="{{ package.id }}"
                                                    data-reservation_number="{{ package.reservation_number }}"
                                                    data-user_id="{{ package.user.id }}"
                                                    data-user="{{ package.user.first_name }} {{ package.user.last_name }}"
                                                    data-car_model_id="{{ package.car_model.id }}"
                                                    data-car="{{ package.car_model.title }}"
                                                    data-title="{{ package.title }}"
                                                    data-features="{{ package.extra_features }}"
                                                    data-price="{{ package.price }}"
                                                    data-status="{{ package.status }}"
                                                    data-build_type="{{ package.build_type }}"
                                                    data-build_status="{{ package.build_status }}"
                                                    data-build_payment_amount="{{ package.build_payment_amount }}"
                                                    data-build_message="{{ package.build_message }}"
                                                    data-created_at="{{ package.created_at|date:'Y-m-d H:i' }}"
                                                    data-updated_at="{{ package.updated_at|date:'Y-m-d H:i' }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-info action-btn edit-btn"
                                                    data-id="{{ package.id }}"
                                                    data-reservation_number="{{ package.reservation_number }}"
                                                    data-user_id="{{ package.user.id }}"
                                                    data-user="{{ package.user.first_name }} {{ package.user.last_name }}"
                                                    data-car_model_id="{{ package.car_model.id }}"
                                                    data-car="{{ package.car_model.title }}"
                                                    data-title="{{ package.title }}"
                                                    data-features="{{ package.extra_features }}"
                                                    data-price="{{ package.price }}"
                                                    data-status="{{ package.status }}"
                                                    data-build_type="{{ package.build_type }}"
                                                    data-build_status="{{ package.build_status }}"
                                                    data-build_payment_amount="{{ package.build_payment_amount }}"
                                                    data-build_message="{{ package.build_message }}"
                                                    data-created_at="{{ package.created_at|date:'Y-m-d H:i' }}"
                                                    data-updated_at="{{ package.updated_at|date:'Y-m-d H:i' }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger action-btn delete-btn"
                                                    data-id="{{ package.id }}"
                                                    data-status="{{ package.status }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1" role="dialog" aria-labelledby="editReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReservationModalLabel">Update Reservation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editReservationForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="car_model_id" name="car_model">
                    <input type="hidden" id="user_id" name="user">
                    <div class="row">
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>User</label>
                                <input type="text" class="form-control" id="user_name" readonly>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Reservation Number</label>
                                <input type="text" class="form-control" id="reservation_number" name="reservation_number" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Car Model</label>
                                <input type="text" class="form-control" id="car_model" readonly>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Package Title</label>
                                <input type="text" name="title" class="form-control" id="package_title" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Price</label>
                                <input type="text" name="price" class="form-control" id="package_price" readonly>
                            </div>
                        </div>
                        <!-- <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Build Payment Amount</label>
                                <input type="number" class="form-control" id="build_payment_amount" name="build_payment_amount">
                            </div>
                        </div> -->
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-12">
                            <div class="form-group">
                                <label>Status</label>
                                <select class="status-select form-control" id="reservation_status" name="status">
                                    {% for value, label in booked_packages.first.STATUS_CHOICES %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="form-group">
                                <label>Build Type</label>
                                <select class="status-select form-control" id="build_type" name="build_type">
                                    {% for value, label in booked_packages.first.BUILD_TYPE_CHOICES %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="form-group">
                                <label>Build Status</label>
                                <select class="status-select form-control" id="build_status" name="build_status">
                                    {% for value, label in booked_packages.first.BUILD_STATUS_CHOICES %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label>Extra Features</label>
                                <textarea class="form-control" id="extra_features" name="extra_features" rows="2" readonly></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label>Message</label>
                                <textarea class="form-control" id="build_message" name="build_message" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Created At</label>
                                <input type="text" class="form-control" id="created_at" readonly>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label>Updated At</label>
                                <input type="text" class="form-control" id="updated_at" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="urls" data-update-url="{% url 'update-booked-package' '00000000-0000-0000-0000-000000000000' %}"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-sm btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" role="dialog" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Reservation Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>User</label>
                            <input type="text" class="form-control" id="view_user_name" readonly>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>Reservation Number</label>
                            <input type="text" class="form-control" id="view_reservation_number" readonly>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>Car Model</label>
                            <input type="text" class="form-control" id="view_car_model" readonly>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>Package Title</label>
                            <input type="text" class="form-control" id="view_package_title" readonly>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>Price</label>
                            <input type="text" class="form-control" id="view_package_price" readonly>
                        </div>
                    </div>
                    <!-- <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>Build Payment Amount</label>
                            <input type="text" class="form-control" id="view_build_payment_amount" readonly>
                        </div>
                    </div> -->
                </div>
                <div class="row">
                    <div class="col-md-4 col-12">
                        <div class="form-group">
                            <label>Status</label>
                            <input type="text" class="form-control" id="view_reservation_status" readonly>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="form-group">
                            <label>Build Type</label>
                            <input type="text" class="form-control" id="view_build_type" readonly>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="form-group">
                            <label>Build Status</label>
                            <input type="text" class="form-control" id="view_build_status" readonly>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group">
                            <label>Extra Features</label>
                            <textarea class="form-control" id="view_extra_features" rows="2" readonly></textarea>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group">
                            <label>Message</label>
                            <textarea class="form-control" id="view_build_message" rows="2" readonly></textarea>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>Created At</label>
                            <input type="text" class="form-control" id="view_created_at" readonly>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <div class="form-group">
                            <label>Updated At</label>
                            <input type="text" class="form-control" id="view_updated_at" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="{% static 'admin/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'admin/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'admin/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'admin/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'admin/plugins/sweetalert2/sweetalert2.min.js' %}"></script>
<script>
$(document).ready(function () {
    // Initialize DataTables
    const oTable = $('#package_tbl').DataTable({
        responsive: true,
        paging: true,
        lengthChange: false,
        searching: true,
        info: true,
        ordering: false,
        autoWidth: false,
        dom: 'lrtip',
        language: {
            search: '',
            searchPlaceholder: 'Search...'
        }
    });

    // Debounced search input
    let searchTimeout;
    $('#myInputTextField').on('keyup', function () {
        clearTimeout(searchTimeout);
        const value = $(this).val();
        searchTimeout = setTimeout(() => {
            oTable.search(value).draw();
        }, 300);
    });

    // Initialize filters from URL parameters
    function initFilters() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('status')) {
            $('#statusFilter').val(urlParams.get('status'));
            oTable.column(5).search(urlParams.get('status')).draw();
        }
        if (urlParams.has('build_type')) {
            $('#buildTypeFilter').val(urlParams.get('build_type'));
            oTable.column(6).search(urlParams.get('build_type')).draw();
        }
        if (urlParams.has('build_status')) {
            $('#buildStatusFilter').val(urlParams.get('build_status'));
            oTable.column(7).search(urlParams.get('build_status')).draw();
        }
    }
    initFilters();

    // Filter event handlers
    $('#statusFilter').on('change', function () {
        oTable.column(5).search($(this).val()).draw();
        updateUrlParams();
    });

    $('#buildTypeFilter').on('change', function () {
        oTable.column(6).search($(this).val()).draw();
        updateUrlParams();
    });

    $('#buildStatusFilter').on('change', function () {
        oTable.column(7).search($(this).val()).draw();
        updateUrlParams();
    });

    // Update URL parameters without reloading
    function updateUrlParams() {
        const url = new URL(window.location);
        const params = {
            status: $('#statusFilter').val(),
            build_type: $('#buildTypeFilter').val(),
            build_status: $('#buildStatusFilter').val()
        };

        Object.keys(params).forEach(key => {
            if (params[key]) {
                url.searchParams.set(key, params[key]);
            } else {
                url.searchParams.delete(key);
            }
        });

        window.history.pushState({}, '', url);
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // View button handler
    $(document).on('click touchstart', '.view-btn', function (e) {
        e.preventDefault();
        try {
            const data = $(this).data();
            const formattedStatus = data.status ? data.status.charAt(0).toUpperCase() + data.status.slice(1).replace(/_/g, ' ') : '';
            const formattedBuildType = data.build_type ? data.build_type.charAt(0).toUpperCase() + data.build_type.slice(1).replace(/_/g, ' ') : '';
            const formattedBuildStatus = data.build_status ? data.build_status.charAt(0).toUpperCase() + data.build_status.slice(1).replace(/_/g, ' ') : '';

            $('#view_reservation_number').val(data.reservation_number || '');
            $('#view_user_name').val(data.user || '');
            $('#view_car_model').val(data.car || '');
            $('#view_package_title').val(data.title || '');
            $('#view_extra_features').val(data.features || '');
            $('#view_package_price').val(data.price || '');
            $('#view_reservation_status').val(formattedStatus);
            $('#view_build_type').val(formattedBuildType);
            $('#view_build_status').val(formattedBuildStatus);
            $('#view_build_payment_amount').val(data.build_payment_amount || '0');
            $('#view_build_message').val(data.build_message || '');
            $('#view_created_at').val(data.created_at || '');
            $('#view_updated_at').val(data.updated_at || '');

            $('#viewDetailsModal').modal('show');
        } catch (error) {
            console.error('Error in view button handler:', error);
            Swal.fire({
                position: 'top-end',
                icon: 'error',
                title: 'Error',
                text: 'Failed to open view details',
                showConfirmButton: false,
                timer: 3000,
                toast: true
            });
        }
    });

    // Edit button handler
    $(document).on('click touchstart', '.edit-btn', function (e) {
        e.preventDefault();
        const data = $(this).data();
        const urlPattern = $('#urls').data('update-url');
        const url = urlPattern.replace('00000000-0000-0000-0000-000000000000', data.id);

        $('#reservation_number').val(data.reservation_number || '');
        $('#user_id').val(data.user_id || '');
        $('#car_model_id').val(data.car_model_id || '');
        $('#user_name').val(data.user || '');
        $('#car_model').val(data.car || '');
        $('#package_title').val(data.title || '');
        $('#extra_features').val(data.features || '');
        $('#package_price').val(data.price || '');
        $('#reservation_status').val(data.status || '');
        $('#build_type').val(data.build_type || '');
        $('#build_status').val(data.build_status || '');
        $('#build_payment_amount').val(data.build_payment_amount || '0');
        $('#build_message').val(data.build_message || '');
        $('#created_at').val(data.created_at || '');
        $('#updated_at').val(data.updated_at || '');
        $('#editReservationForm').attr('action', url);

        $('#editReservationModal').modal('show');
    });

    // Form submission handler
    $('#editReservationForm').on('submit', function (e) {
        e.preventDefault();
        const form = $(this);
        const url = form.attr('action');

        $.ajax({
            type: 'POST',
            url: url,
            data: form.serialize(),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function () {
                $('#editReservationModal').modal('hide');
                Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'Reservation updated successfully!',
                    showConfirmButton: false,
                    timer: 1500,
                    toast: true
                });
                setTimeout(() => location.reload(), 1500);
            },
            error: function (xhr) {
                Swal.fire({
                    position: 'top-end',
                    icon: 'error',
                    title: 'Error updating reservation',
                    text: xhr.responseJSON?.error || 'An unknown error occurred',
                    showConfirmButton: false,
                    timer: 3000,
                    toast: true
                });
            }
        });
    });

    // Delete button handler
    $(document).on('click touchstart', '.delete-btn', function (e) {
        e.preventDefault();
        const id = $(this).data('id');
        const status = $(this).data('status');
        const url = "{% url 'delete-booked-package' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', id);

        if (status !== 'pending' && status !== 'cancelled') {
            Swal.fire({
                position: 'top-end',
                icon: 'error',
                title: 'Error deleting reservation',
                text: 'Only pending and cancelled reservations can be deleted',
                showConfirmButton: false,
                timer: 3000,
                toast: true
            });
            return;
        }

        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: 'POST',
                    url: url,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function () {
                        Swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            title: 'Reservation deleted successfully!',
                            showConfirmButton: false,
                            timer: 1500,
                            toast: true
                        });
                        setTimeout(() => location.reload(), 1500);
                    },
                    error: function (xhr) {
                        Swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title: 'Error deleting reservation',
                            text: xhr.responseJSON?.error || 'An unknown error occurred',
                            showConfirmButton: false,
                            timer: 3000,
                            toast: true
                        });
                    }
                });
            }
        });
    });

    // Reset modals on close
    $('#editReservationModal, #viewDetailsModal').on('hidden.bs.modal', function () {
        $(this).find('form').trigger('reset');
    });
});
</script>
{% endblock %}